<?php

namespace luya\headless\tests\modules\cms;

use luya\headless\tests\HeadlessTestCase;
use luya\headless\modules\cms\Page;
use luya\headless\modules\cms\Menu;
use luya\headless\modules\cms\PageRenderer;

final class PageTest extends HeadlessTestCase
{
    public function testGetPageContent()
    {
        $client = $this->createDummyClient('{"item":{"id":1},"nav":{"id":1},"error": 0}');

        $page = Page::find(1, 1)->response($client);

        $this->assertSame(1, $page->item->id);
        $this->assertSame(1, $page->nav->id);
        $this->assertSame(0, $page->error);
    }

    public function testBlockModelResponse()
    {
        $client = $this->createDummyClient('{"error":false,"item":{"id":1,"nav_id":1,"lang_id":1,"nav_item_type":1,"nav_item_type_id":1,"create_user_id":1,"update_user_id":1,"timestamp_create":1491900875,"timestamp_update":1527002267,"title":"Homepage","alias":"homepage","description":"The demo application Website for your LUYA Project.","keywords":"yii2,luya,demo,php,website","title_tag":"The LUYA Demo Homepage"},"nav":{"id":1,"nav_container_id":1,"parent_nav_id":0,"sort_index":1,"is_deleted":0,"is_hidden":0,"is_home":1,"is_offline":0,"is_draft":0,"layout_file":null,"publish_from":null,"publish_till":null},"typeData":{"1":{"id":1,"layout_id":1,"nav_item_id":1,"timestamp_create":1491900875,"create_user_id":1,"version_alias":"First version","contentAsArray":{"nav_item_page":{"id":"1","layout_id":"1","layout_name":"2spalten"},"__placeholders":[[{"cols":8,"var":"content","label":"Main Container","nav_item_page_id":1,"prev_id":0,"__nav_item_page_block_items":[{"is_dirty":true,"is_container":0,"id":"1","block_id":"18","is_hidden":"0","name":"Heading","icon":"format_size","full_name":"<i class=\"material-icons\">format_size</i> <span>Heading</span>","twig_admin":"{% if vars.content is not empty %}<{{vars.headingType}}>{{ vars.content }}</{{vars.headingType}}>{% else %}<span class=\"block__empty-text\">No heading data has been provided yet.</span>{% endif %}","vars":[{"id":"9b351bbac43854bde809afef08f521f9","var":"content","label":"Title","type":"zaa-text","placeholder":null,"options":null,"initvalue":null},{"id":"3cdd8aa6af9f39ce84e1f023554bd540","var":"headingType","label":"Size","type":"zaa-select","placeholder":null,"options":[{"value":"h1","label":"Heading 1"},{"value":"h2","label":"Heading 2"},{"value":"h3","label":"Heading 3"},{"value":"h4","label":"Heading 4"},{"value":"h5","label":"Heading 5"}],"initvalue":"h1"}],"cfgs":[{"id":"73295951d6ddd5e2d41ca2c4bd99f1c8","var":"cssClass","label":"CSS classes","type":"zaa-text","placeholder":null,"options":null,"initvalue":null}],"extras":[],"values":{"headingType":"h1","content":"LUYA DEMO"},"field_help":[],"cfgvalues":{"__e":"__o"},"__placeholders":[],"variations":false,"variation":"0","is_dirty_dialog_enabled":true},{"is_dirty":true,"is_container":0,"id":"2","block_id":"18","is_hidden":"0","name":"Heading","icon":"format_size","full_name":"<i class=\"material-icons\">format_size</i> <span>Heading</span>","twig_admin":"{% if vars.content is not empty %}<{{vars.headingType}}>{{ vars.content }}</{{vars.headingType}}>{% else %}<span class=\"block__empty-text\">No heading data has been provided yet.</span>{% endif %}","vars":[{"id":"d96a2928fd8b8ff934de123cdadc839f","var":"content","label":"Title","type":"zaa-text","placeholder":null,"options":null,"initvalue":null},{"id":"e29dfe39e7c4f25bacc11c7b475d3ce6","var":"headingType","label":"Size","type":"zaa-select","placeholder":null,"options":[{"value":"h1","label":"Heading 1"},{"value":"h2","label":"Heading 2"},{"value":"h3","label":"Heading 3"},{"value":"h4","label":"Heading 4"},{"value":"h5","label":"Heading 5"}],"initvalue":"h1"}],"cfgs":[{"id":"0fc1829a569495da032f2b7be8d601a2","var":"cssClass","label":"CSS classes","type":"zaa-text","placeholder":null,"options":null,"initvalue":null}],"extras":[],"values":{"headingType":"h2","content":"POWER TO YOU!"},"field_help":[],"cfgvalues":{"__e":"__o"},"__placeholders":[],"variations":false,"variation":"0","is_dirty_dialog_enabled":true},{"is_dirty":true,"is_container":0,"id":"5","block_id":"18","is_hidden":"0","name":"Heading","icon":"format_size","full_name":"<i class=\"material-icons\">format_size</i> <span>Heading</span>","twig_admin":"{% if vars.content is not empty %}<{{vars.headingType}}>{{ vars.content }}</{{vars.headingType}}>{% else %}<span class=\"block__empty-text\">No heading data has been provided yet.</span>{% endif %}","vars":[{"id":"6dd38c5717b5331d4d3e5545f555beca","var":"content","label":"Title","type":"zaa-text","placeholder":null,"options":null,"initvalue":null},{"id":"05e4c07efd21c470611a6fb6ac48e708","var":"headingType","label":"Size","type":"zaa-select","placeholder":null,"options":[{"value":"h1","label":"Heading 1"},{"value":"h2","label":"Heading 2"},{"value":"h3","label":"Heading 3"},{"value":"h4","label":"Heading 4"},{"value":"h5","label":"Heading 5"}],"initvalue":"h1"}],"cfgs":[{"id":"557d6a57ec86ee62ce54cbb1ef6d2fbc","var":"cssClass","label":"CSS classes","type":"zaa-text","placeholder":null,"options":null,"initvalue":null}],"extras":[],"values":{"headingType":"h3","content":"LUYA is a fast and flexible framework and content management system built with the goal to please developers, clients and users alike."},"field_help":[],"cfgvalues":{"__e":"__o"},"__placeholders":[],"variations":false,"variation":"0","is_dirty_dialog_enabled":true},{"is_dirty":false,"is_container":0,"id":"32","block_id":"15","is_hidden":"0","name":"Space","icon":"format_line_spacing","full_name":"<i class=\"material-icons\">format_line_spacing</i> <span>Space</span>","twig_admin":"<span class=\"block__empty-text\">{{ extras.spacingLabel }}</span>","vars":[{"id":"8d5ae11f2724f15224831dddffd94cd3","var":"spacing","label":"Space","type":"zaa-select","placeholder":null,"options":[{"value":1,"label":"Small space"},{"value":2,"label":"Medium space"},{"value":3,"label":"Large space"}],"initvalue":1}],"cfgs":[],"extras":{"spacingLabel":"Small space"},"values":{"spacing":1},"field_help":[],"cfgvalues":{"__e":"__o"},"__placeholders":[],"variations":false,"variation":"0","is_dirty_dialog_enabled":false},{"is_dirty":true,"is_container":0,"id":"6","block_id":"6","is_hidden":"0","name":"Image","icon":"crop","full_name":"<i class=\"material-icons\">crop</i> <span>Image</span>","twig_admin":"{% if extras.imageAdmin.source %}<p><img src=\"{{extras.imageAdmin.source}}\"{% if cfgs.width %} width=\"{{cfgs.width}}\"{% endif %}{% if cfgs.height %} height=\"{{cfgs.height}}\"{% endif %} border=\"0\" style=\"max-width: 100%;\"></p>{% else %}<span class=\"block__empty-text\">No images have been uploaded yet.</span>{% endif %}{% if vars.caption is not empty %}{{extras.text}}{% endif %}","vars":[{"id":"4348722eefb0c91371883943ac442d60","var":"imageId","label":"Image upload","type":"zaa-image-upload","placeholder":null,"options":null,"initvalue":null},{"id":"771fa8b2f2b0f0b748983c6c3981ea48","var":"caption","label":"Image caption","type":"zaa-textarea","placeholder":null,"options":null,"initvalue":null},{"id":"157397ed54ead9c81ace345d7d419609","var":"textType","label":"block_text_texttype_label","type":"zaa-select","placeholder":null,"options":[{"value":0,"label":"block_text_texttype_normal"},{"value":1,"label":"block_text_texttype_markdown"}],"initvalue":0}],"cfgs":[{"id":"9155a1b61b11077edae1f8e133627b29","var":"width","label":"Fixed image width","type":"zaa-text","placeholder":null,"options":null,"initvalue":null},{"id":"338dd24b4755e64569ea3369731930bd","var":"height","label":"Fixed image height","type":"zaa-text","placeholder":null,"options":null,"initvalue":null},{"id":"4fbe1a4de87e4339a90c28048ee4da94","var":"internalLink","label":"Internal Link","type":"zaa-cms-page","placeholder":null,"options":null,"initvalue":null},{"id":"a529996ee3d01f700126cb83dec8e123","var":"externalLink","label":"External Link (overrides internal link if set)","type":"zaa-text","placeholder":null,"options":null,"initvalue":null},{"id":"10e9927aa4d96077cb249ffc0353c565","var":"cssClass","label":"CSS classes for image","type":"zaa-text","placeholder":null,"options":null,"initvalue":null},{"id":"1e2b18f20690066f99ba34115f4cb8fd","var":"divCssClass","label":"CSS classes","type":"zaa-text","placeholder":null,"options":null,"initvalue":null}],"extras":{"image":{"id":45,"fileId":13,"filterId":2,"source":"/storage/2_luya-rc4-cms_c862cc64.png","serverSource":"/var/www/vhosts/luya.io/demo.luya.io/current/public_html/storage/2_luya-rc4-cms_c862cc64.png","resolutionWidth":800,"resolutionHeight":484,"caption":""},"imageAdmin":{"id":45,"fileId":13,"filterId":2,"source":"/storage/2_luya-rc4-cms_c862cc64.png","serverSource":"/var/www/vhosts/luya.io/demo.luya.io/current/public_html/storage/2_luya-rc4-cms_c862cc64.png","resolutionWidth":800,"resolutionHeight":484,"caption":""},"text":null,"link":false},"values":{"textType":0,"imageId":45,"caption":""},"field_help":[],"cfgvalues":{"__e":"__o"},"__placeholders":[],"variations":false,"variation":"0","is_dirty_dialog_enabled":true},{"is_dirty":true,"is_container":0,"id":"50","block_id":"10","is_hidden":"0","name":"Link Button","icon":"link","full_name":"<i class=\"material-icons\">link</i> <span>Link Button</span>","twig_admin":"<p>{% if vars.label is empty or vars.linkData is empty %}Link Button: The link target is empty.{% else %}{% if vars.label is not empty %}<a class=\"btn disabled\">{{ vars.label }}</a>{% endif %}{% endif %}</p>","vars":[{"id":"0357b24c5c3b330bb416aaa1c60a5eb5","var":"linkData","label":"Link Address","type":"zaa-link","placeholder":null,"options":null,"initvalue":null},{"id":"a9673e8dbff0425050fb7df9367e439c","var":"label","label":"Button Label","type":"zaa-text","placeholder":null,"options":null,"initvalue":null}],"cfgs":[{"id":"a45471b82801effa96e9666f5667a2a9","var":"simpleLink","label":"Use a simple link","type":"zaa-checkbox","placeholder":null,"options":null,"initvalue":null}],"extras":{"cssClass":"btn btn-default","linkData":{"href":"https://luya.io/videos","target":"_blank"}},"values":{"linkData":{"type":2,"value":"https://luya.io/videos"},"label":"Watch videos"},"field_help":[],"cfgvalues":{"targetBlank":1,"simpleLink":""},"__placeholders":[],"variations":false,"variation":"0","is_dirty_dialog_enabled":true},{"is_dirty":true,"is_container":0,"id":"49","block_id":"10","is_hidden":"0","name":"Link Button","icon":"link","full_name":"<i class=\"material-icons\">link</i> <span>Link Button</span>","twig_admin":"<p>{% if vars.label is empty or vars.linkData is empty %}Link Button: The link target is empty.{% else %}{% if vars.label is not empty %}<a class=\"btn disabled\">{{ vars.label }}</a>{% endif %}{% endif %}</p>","vars":[{"id":"bfbcfe29d0da09c274d68b04edf5cff4","var":"linkData","label":"Link Address","type":"zaa-link","placeholder":null,"options":null,"initvalue":null},{"id":"542dba0f781a7279a60c98f9d6f7af42","var":"label","label":"Button Label","type":"zaa-text","placeholder":null,"options":null,"initvalue":null}],"cfgs":[{"id":"a3d0d0456ab34b933e114ec7e486cb48","var":"simpleLink","label":"Use a simple link","type":"zaa-checkbox","placeholder":null,"options":null,"initvalue":null}],"extras":{"cssClass":"btn btn-default","linkData":{"href":"https://luya.io/guide","target":"_blank"}},"values":{"linkData":{"type":2,"value":"https://luya.io/guide"},"label":"Installation Guide"},"field_help":[],"cfgvalues":{"targetBlank":1,"simpleLink":""},"__placeholders":[],"variations":false,"variation":"0","is_dirty_dialog_enabled":true},{"is_dirty":true,"is_container":0,"id":"31","block_id":"15","is_hidden":"0","name":"Space","icon":"format_line_spacing","full_name":"<i class=\"material-icons\">format_line_spacing</i> <span>Space</span>","twig_admin":"<span class=\"block__empty-text\">{{ extras.spacingLabel }}</span>","vars":[{"id":"04ee1a43d076dc074bfc1d02d7aca9e0","var":"spacing","label":"Space","type":"zaa-select","placeholder":null,"options":[{"value":1,"label":"Small space"},{"value":2,"label":"Medium space"},{"value":3,"label":"Large space"}],"initvalue":1}],"cfgs":[],"extras":{"spacingLabel":"Small space"},"values":{"spacing":1},"field_help":[],"cfgvalues":{"__e":"__o"},"__placeholders":[],"variations":false,"variation":"0","is_dirty_dialog_enabled":false},{"is_dirty":true,"is_container":0,"id":"4","block_id":"7","is_hidden":"0","name":"Text with image","icon":"recent_actors","full_name":"<i class=\"material-icons\">recent_actors</i> <span>Text with image</span>","twig_admin":"{% if not extras.image.source %}<span class=\"block__empty-text\">No image has been uploaded yet.</span>{% endif %}{% if not extras.text %}<span class=\"block__empty-text\">No text has been insereted yet.</span>{% endif %}{% if extras.image.source and extras.text %}<img src=\"{{ extras.image.source }}\"{% if cfgs.width %} width=\"{{cfgs.width}}\"{% endif %}{% if cfgs.height %} height=\"{{cfgs.height}}\"{% endif %} border=\"0\" style=\"{% if vars.imagePosition == \"left\" %}float:left;{% else %}float:right{% endif %};{% if vars.imagePosition == \"right\" %}margin-left:{{ cfgs.margin }}{% else %}margin-right:{{ cfgs.margin }}{% endif %};margin-bottom:{{ cfgs.margin }}; max-width: 50%;\"\">{{ extras.text }}{% endif %}","vars":[{"id":"ca660004c9b88b645a20cac4d748710e","var":"text","label":"Text","type":"zaa-textarea","placeholder":null,"options":null,"initvalue":null},{"id":"b71e421c467f8ddf32b66347dccb00e3","var":"imageId","label":"Image upload","type":"zaa-image-upload","placeholder":null,"options":null,"initvalue":null},{"id":"7a451fa45ff0c9a0766be38dc3bc2d20","var":"imagePosition","label":"Image position","type":"zaa-select","placeholder":null,"options":[{"value":"left","label":"Left"},{"value":"right","label":"Right"}],"initvalue":"left"}],"cfgs":[{"id":"3f99734721d66abc93df98ff9ef8ad8d","var":"margin","label":"Space between image and text","type":"zaa-select","placeholder":null,"options":[{"value":"5px","label":"0 Pixel"},{"value":"10px","label":"10 Pixel"},{"value":"20px","label":"20 Pixel"},{"value":"30px","label":"30 Pixel"},{"value":"40px","label":"40 Pixel"},{"value":"50px","label":"50 Pixel"}],"initvalue":"20px"},{"id":"a787db76071042fd10489973621d775f","var":"textType","label":"Texttype","type":"zaa-select","placeholder":null,"options":[{"value":"0","label":"Normal text"},{"value":"1","label":"Markdown text"}],"initvalue":0},{"id":"4e34d74f615ddd58cdfc644a2fc9babc","var":"btnLabel","label":"Button label","type":"zaa-text","placeholder":null,"options":null,"initvalue":null},{"id":"d0c27b2c0a6218c096a9bf9e74102f27","var":"btnHref","label":"Button link address","type":"zaa-text","placeholder":null,"options":null,"initvalue":null},{"id":"69e23e5f2431c0328244d043abf6ae7c","var":"targetBlank","label":"Open link an a new window","type":"zaa-checkbox","placeholder":null,"options":null,"initvalue":null},{"id":"9ffd7c6437aae35a3220942d62cff172","var":"width","label":"Fixed image width","type":"zaa-text","placeholder":null,"options":null,"initvalue":null},{"id":"73051ee3fa0a098de37f1a567ade88bc","var":"height","label":"Fixed image height","type":"zaa-text","placeholder":null,"options":null,"initvalue":null}],"extras":{"image":{"id":44,"fileId":14,"filterId":3,"source":"/storage/3_luya-logo-05x_851fbe08.png","serverSource":"/var/www/vhosts/luya.io/demo.luya.io/current/public_html/storage/3_luya-logo-05x_851fbe08.png","resolutionWidth":250,"resolutionHeight":223,"caption":""},"text":"<h3>Community</h3>\n<p><iframe src=\"https://ghbtns.com/github-btn.html?user=luyadev&repo=luya&type=star&count=true\" frameborder=\"0\" scrolling=\"0\" width=\"170px\" height=\"20px\"></iframe></p>\n<p>Every successful open source project needs an active and inspiring community to thrive. This is no different with LUYA.</p>\n<p>Join the young but growing LUYA community, ask questions, provide feedback and translations, amend the documentation, develop modules or help with core development – your participation is welcomed!</p>\n"},"values":{"imagePosition":"left","imageId":44,"text":"### Community\n\n<iframe src=\"https://ghbtns.com/github-btn.html?user=luyadev&repo=luya&type=star&count=true\" frameborder=\"0\" scrolling=\"0\" width=\"170px\" height=\"20px\"></iframe>\n\nEvery successful open source project needs an active and inspiring community to thrive. This is no different with LUYA.\n\nJoin the young but growing LUYA community, ask questions, provide feedback and translations, amend the documentation, develop modules or help with core development – your participation is welcomed!"},"field_help":{"textType":"The text type is referring to the text and not the heading."},"cfgvalues":{"margin":"20px","textType":1,"targetBlank":""},"__placeholders":[],"variations":false,"variation":"0","is_dirty_dialog_enabled":true}]},{"cols":4,"var":"right","label":"Sidebar","nav_item_page_id":1,"prev_id":0,"__nav_item_page_block_items":[{"is_dirty":true,"is_container":0,"id":"91","block_id":"5","is_hidden":"0","name":"HTML","icon":"code","full_name":"<i class=\"material-icons\">code</i> <span>HTML</span>","twig_admin":"    \t{% if vars.html is empty %}\n    \t\t<span class=\"block__empty-text\">No HTML code has been added yet.</span>{% else %}\n    \t\t{% if cfgs.raw == 1 %}\n    \t\t\t{{ vars.html | raw }}\n    \t\t{% else %}\n                <code>{{ vars.html | escape }}</code>\n    \t\t{% endif %}\n    \t{% endif %}","vars":[{"id":"ad23dc99dcf101c737fe5d536271072e","var":"html","label":"HTML code","type":"zaa-textarea","placeholder":null,"options":null,"initvalue":null}],"cfgs":[{"id":"6b917acd95b254454bd6a68c19a23e16","var":"raw","label":"Render HTML in Admin","type":"zaa-checkbox","placeholder":null,"options":null,"initvalue":null}],"extras":[],"values":{"html":"<div class=\"alert alert-info\">This demo will <b>reset every 60 minutes</b>.</div>"},"field_help":[],"cfgvalues":{"__e":"__o"},"__placeholders":[],"variations":false,"variation":"0","is_dirty_dialog_enabled":true},{"is_dirty":true,"is_container":0,"id":"44","block_id":"5","is_hidden":"0","name":"HTML","icon":"code","full_name":"<i class=\"material-icons\">code</i> <span>HTML</span>","twig_admin":"    \t{% if vars.html is empty %}\n    \t\t<span class=\"block__empty-text\">No HTML code has been added yet.</span>{% else %}\n    \t\t{% if cfgs.raw == 1 %}\n    \t\t\t{{ vars.html | raw }}\n    \t\t{% else %}\n                <code>{{ vars.html | escape }}</code>\n    \t\t{% endif %}\n    \t{% endif %}","vars":[{"id":"88398404e50db23d0ba50c9a9cdc02b7","var":"html","label":"HTML code","type":"zaa-textarea","placeholder":null,"options":null,"initvalue":null}],"cfgs":[{"id":"f37a022e117ac9e0d76918aee85b75d5","var":"raw","label":"Render HTML in Admin","type":"zaa-checkbox","placeholder":null,"options":null,"initvalue":null}],"extras":[],"values":{"html":"<a class=\"twitter-timeline\" data-height=\"800\" data-link-color=\"#ff9058\" href=\"https://twitter.com/luyadev\">Tweets by luyadev</a> <script async src=\"//platform.twitter.com/widgets.js\" charset=\"utf-8\"></script>"},"field_help":[],"cfgvalues":{"__e":"__o"},"__placeholders":[],"variations":false,"variation":"0","is_dirty_dialog_enabled":true}]}]]}}}}');
    
        $page = Page::find(1, 1)->response($client);

        $ids = [];
        foreach ($page->getCurrentPageVersion()->getRows() as $row) {
            foreach ($row->getCols() as $col) {
                foreach ($col->getBlocks() as $block) {
                    $ids[] = $block->id;
                }
            }
        }

        $this->assertEquals([1, 2, 5, 32, 6, 50, 49, 31, 4, 91, 44], $ids);

        // render page

        $renderer = new PageRenderer($page->getCurrentPageVersion());
        
        TestBlock::register(18, $renderer);
        TestBlock::register(15, $renderer);
        TestBlock::register(6, $renderer);
        TestBlock::register(10, $renderer);
        TestBlock::register(7, $renderer);
        TestBlock::register(5, $renderer);

        $this->assertNotNull($renderer->render());
    }

    public function testMenu()
    {
        $json = <<<'JSON'
        [[{"id":"1","nav_container_id":"2","parent_nav_id":"0","sort_index":"1","is_deleted":"0","is_hidden":"0","is_home":"0","is_offline":"0","is_draft":"0","layout_file":null,"publish_from":null,"publish_till":null,"item":{"id":"1","nav_id":"1","lang_id":"1","nav_item_type":"1","nav_item_type_id":"1","create_user_id":"1","update_user_id":"1","timestamp_create":"1531071213","timestamp_update":"1536064989","title":"Test Page 1","alias":"test-page-1","description":null,"keywords":null,"title_tag":null}},{"id":"2","nav_container_id":"2","parent_nav_id":"0","sort_index":"2","is_deleted":"0","is_hidden":"0","is_home":"0","is_offline":"0","is_draft":"0","layout_file":null,"publish_from":null,"publish_till":null,"item":{"id":"2","nav_id":"2","lang_id":"1","nav_item_type":"1","nav_item_type_id":"2","create_user_id":"1","update_user_id":"1","timestamp_create":"1531075178","timestamp_update":"1536065316","title":"Seite mit layout block","alias":"seite-mit-layout-block","description":"","keywords":null,"title_tag":null}}]]    
JSON;
        $client = $this->createDummyClient($json);
        
        $items = Menu::find()->container(1)->language(1)->root()->response($client);

        $first = $items[1];
        
        $this->assertSame('Test Page 1', $first->item->title);
        $this->assertSame("0", $first->is_offline);
    }
}
